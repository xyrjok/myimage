<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§äººå›¾åºŠ - ç®¡ç†åå°</title>
    <link id="dynamic-favicon" rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        :root { --primary: #0051c3; --bg: #f4f4f9; --text: #333; --sidebar-bg: #2c3e50; --sidebar-hover: #34495e; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .hidden { display: none !important; }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container { max-width: 400px; margin: 100px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-danger { background: #dc3545; }

        /* åå°æ•´ä½“å¸ƒå±€ */
        .layout { display: flex; min-height: 100vh; }
        
        /* å·¦ä¾§è¾¹æ  */
        .sidebar { width: 220px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid #1a252f; font-weight: bold; font-size: 18px; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent; transition: 0.3s; }
        .nav-item:hover { background: var(--sidebar-hover); }
        .nav-item.active { border-left-color: #3498db; background: var(--sidebar-hover); }
        .logout-btn { margin-top: auto; padding: 15px 20px; cursor: pointer; background: #c0392b; text-align: center; }
        .logout-btn:hover { background: #e74c3c; }

        /* å³ä¾§å†…å®¹åŒº */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; height: 100vh; box-sizing: border-box; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* å›¾ç‰‡ç®¡ç†åŒº */
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; margin-bottom: 20px; background: #fff; transition: 0.3s; }
        .upload-area.dragover { background: #e9ecef; border-color: var(--primary); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .image-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fff; display: flex; flex-direction: column; }
        .image-card img { width: 100%; height: 180px; object-fit: cover; }
        .image-info { padding: 15px; flex-grow: 1; }
        .image-info input { width: 100%; margin-top: 5px; margin-bottom: 10px; font-size: 12px; }
        .card-actions { display: flex; justify-content: space-between; padding: 10px 15px; background: #f8f9fa; border-top: 1px solid #eee; }

        /* ç³»ç»Ÿè®¾ç½®åŒº */
        .settings-card { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-width: 600px; }
        .settings-card label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .settings-card input { margin-bottom: 20px; }
        .settings-help { font-size: 12px; color: #888; margin-top: -15px; margin-bottom: 20px; display: block; }
    </style>
</head>
<body>

<div class="login-container" id="login-view">
    <h2 style="text-align: center;">ğŸ”’ å›¾åºŠæ§åˆ¶å°ç™»å½•</h2>
    <div class="form-group">
        <input type="text" id="username" placeholder="åå°è´¦å·">
    </div>
    <div class="form-group">
        <input type="password" id="password" placeholder="åå°å¯†ç ">
    </div>
    <button onclick="login()" style="width: 100%;">å®‰å…¨ç™»å½•</button>
</div>

<div class="layout hidden" id="admin-view">
    <div class="sidebar">
        <div class="sidebar-header">ğŸŒŒ å›¾åºŠç®¡ç†ç³»ç»Ÿ</div>
        <div class="nav-item active" onclick="switchTab('images')" id="nav-images">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</div>
        <div class="nav-item" onclick="switchTab('settings')" id="nav-settings">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
        <div class="logout-btn" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <h2 id="page-title">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</h2>
            <a href="/" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: bold;">ğŸŒ æŸ¥çœ‹å‰å°ç”»å»Š</a>
        </div>

        <div id="tab-images">
            <div class="upload-area" id="drop-zone">
                <h3>ğŸ“¤ ä¸Šä¼ æ–°å›¾ç‰‡ (æ”¯æŒæ‹–æ‹½å’Œæ‰¹é‡)</h3>
                <input type="file" id="fileInput" accept="image/*" multiple style="margin-bottom: 10px;">
                <button onclick="uploadImage()">å¼€å§‹ä¸Šä¼ </button>
                <div id="uploadStatus" style="margin-top: 10px; color: #28a745; font-weight: bold;"></div>
            </div>

            <h3>ğŸ“‚ æˆ‘çš„å›¾åº“ <button onclick="loadImages()" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">åˆ·æ–°</button></h3>
            <div class="gallery-grid" id="gallery"></div>
        </div>

        <div id="tab-settings" class="hidden">
            <div class="settings-card">
                <label>Telegram Bot Token (TG_BOT_TOKEN)</label>
                <input type="text" id="set_tg_bot_token" placeholder="123456:ABC-DEF1234ghIkl...">
                <span class="settings-help">ä½ çš„æœºå™¨äºº Tokenï¼Œç”¨äºè°ƒç”¨ TG API</span>

                <label>Telegram Chat ID (TG_CHAT_ID)</label>
                <input type="text" id="set_tg_chat_id" placeholder="-100123456789">
                <span class="settings-help">å›¾ç‰‡å®ä½“å­˜æ”¾çš„ç§æœ‰é¢‘é“ ID</span>

                <label>API Key (API_KEY)</label>
                <input type="text" id="set_api_key" placeholder="sk-your-secret-key">
                <span class="settings-help">å¤–éƒ¨åšå®¢/ç³»ç»Ÿè°ƒç”¨å›¾åºŠ API æ—¶çš„é‰´æƒå¯†é’¥</span>

                <label>åå°è´¦å· (ADMIN_USER)</label>
                <input type="text" id="set_admin_user" placeholder="admin">
                
                <label>åå°å¯†ç  (ADMIN_PASS)</label>
                <input type="text" id="set_admin_pass" placeholder="åœ¨æ­¤ä¿®æ”¹å¯†ç ">

                <label>ç½‘ç«™å›¾æ ‡ (SITE_FAVICON)</label>
                <input type="text" id="set_site_favicon" placeholder="https://...">
                <span class="settings-help">å‰åå°ç½‘é¡µæ ‡ç­¾é¡µæ˜¾ç¤ºçš„ favicon å›¾æ ‡ç›´é“¾</span>

                <button onclick="saveSettings()" style="width: 100%; margin-top: 10px;">ğŸ’¾ ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
                <div id="settingsStatus" style="margin-top: 15px; text-align: center; font-weight: bold;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // âš ï¸ åœ¨è¿™é‡Œç›´æ¥å†™æ­»ä½ çš„åç«¯ Worker API åŸŸåï¼ˆæ³¨æ„æœ«å°¾ä¸è¦åŠ  /ï¼‰
    // å¦‚æœä½ çš„åç«¯åŸŸåæœ‰å˜ï¼Œè¯·ä¿®æ”¹è¿™é‡Œ
    const apiBaseUrl = "https://img.emx.dpdns.org"; 
    
    let authHeader = localStorage.getItem('imgbed_auth') || '';

    window.onload = () => {
        if (authHeader) {
            showAdmin();
            loadImages();
            loadSettings(); // åŠ è½½è®¾ç½®
        }
    };

    // --- é¡µé¢åˆ‡æ¢é€»è¾‘ ---
    function switchTab(tabName) {
        document.getElementById('tab-images').classList.add('hidden');
        document.getElementById('tab-settings').classList.add('hidden');
        document.getElementById('nav-images').classList.remove('active');
        document.getElementById('nav-settings').classList.remove('active');

        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        document.getElementById(`nav-${tabName}`).classList.add('active');

        if (tabName === 'images') {
            document.getElementById('page-title').innerText = 'ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†';
            loadImages();
        } else if (tabName === 'settings') {
            document.getElementById('page-title').innerText = 'âš™ï¸ ç³»ç»Ÿè®¾ç½®';
            loadSettings();
        }
    }

    // --- ç™»å½•ä¸åŸºç¡€æ§åˆ¶ ---
    async function login() {
        const user = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value.trim();
        if (!user || !pass) return alert("è¯·å¡«å†™å®Œæ•´çš„è´¦å·å’Œå¯†ç ï¼");
        
        const tempAuth = 'Basic ' + btoa(user + ':' + pass);
        try {
            const res = await fetch(`${apiBaseUrl}/api/admin/images`, { headers: { 'Authorization': tempAuth } });
            if (res.status === 401) throw new Error("è´¦å·æˆ–å¯†ç é”™è¯¯");
            if (!res.ok) throw new Error("API åœ°å€è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç ä¸­å†™æ­»çš„åŸŸåæ˜¯å¦æ­£ç¡®");
            
            authHeader = tempAuth;
            localStorage.setItem('imgbed_auth', authHeader);
            showAdmin();
            loadImages();
            loadSettings();
        } catch (err) { alert("ç™»å½•å¤±è´¥: " + err.message); }
    }

    function logout() {
        localStorage.removeItem('imgbed_auth');
        document.getElementById('login-view').classList.remove('hidden');
        document.getElementById('admin-view').classList.add('hidden');
        document.getElementById('password').value = ''; // é€€å‡ºæ—¶æ¸…ç©ºå¯†ç æ¡†
    }

    function showAdmin() {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('admin-view').classList.remove('hidden');
    }

    // --- å›¾ç‰‡ç®¡ç†é€»è¾‘ ---
    async function uploadImage() {
        const fileInput = document.getElementById('fileInput');
        const files = fileInput.files;
        const statusEl = document.getElementById('uploadStatus');
        
        if (files.length === 0) return alert("è¯·å…ˆé€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡");
        
        let successCount = 0;
        let failCount = 0;
        fileInput.disabled = true;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            statusEl.innerText = `æ­£åœ¨ä¸Šä¼  (${i + 1}/${files.length}): ${file.name}...`;
            statusEl.style.color = "#0051c3";
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${apiBaseUrl}/api/admin/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader },
                    body: formData
                });
                if (!res.ok) throw new Error(await res.text());
                successCount++;
            } catch (err) { failCount++; }
        }

        statusEl.innerText = `âœ… ä¸Šä¼ å®Œæˆï¼æˆåŠŸ: ${successCount} å¼ ï¼Œå¤±è´¥: ${failCount} å¼ `;
        statusEl.style.color = failCount > 0 ? "#dc3545" : "#28a745";
        
        fileInput.value = '';
        fileInput.disabled = false;
        loadImages();

        setTimeout(() => { if (statusEl.innerText.includes("ä¸Šä¼ å®Œæˆ")) statusEl.innerText = ""; }, 5000);
    }

    async function loadImages() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = 'åŠ è½½ä¸­...';
        try {
            const res = await fetch(`${apiBaseUrl}/api/admin/images`, { headers: { 'Authorization': authHeader } });
            const data = await res.json();
            gallery.innerHTML = data.map(img => `
                <div class="image-card" id="img-${img.id}">
                    <a href="${img.url}" target="_blank"><img src="${img.url}" alt="image"></a>
                    <div class="image-info">
                        <input type="text" value="${img.url}" readonly onclick="this.select()">
                    </div>
                    <div class="card-actions">
                        <button onclick="copyText('${img.url}')" style="background:#28a745; padding: 5px 10px;">å¤åˆ¶ç›´é“¾</button>
                        <button class="btn-danger" onclick="deleteImage(${img.id})" style="padding: 5px 10px;">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        } catch (err) { gallery.innerHTML = 'åŠ è½½å¤±è´¥'; }
    }

    async function deleteImage(id) {
        if(!confirm("ç¡®å®šå½»åº•åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼ŸTGç«¯ä¹Ÿä¼šåŒæ­¥æ’¤å›ï¼")) return;
        try {
            const res = await fetch(`${apiBaseUrl}/api/admin/delete`, {
                method: 'POST',
                headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            if(res.ok) document.getElementById(`img-${id}`).remove();
            else alert("åˆ é™¤å¤±è´¥");
        } catch(err) { alert("é”™è¯¯: " + err.message); }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => alert("é“¾æ¥å·²å¤åˆ¶ï¼"));
    }

    // --- ç³»ç»Ÿè®¾ç½®é€»è¾‘ ---
    async function loadSettings() {
        try {
            const res = await fetch(`${apiBaseUrl}/api/admin/settings`, { headers: { 'Authorization': authHeader } });
            const settings = await res.json();
            
            if (settings.tg_bot_token) document.getElementById('set_tg_bot_token').value = settings.tg_bot_token;
            if (settings.tg_chat_id) document.getElementById('set_tg_chat_id').value = settings.tg_chat_id;
            if (settings.api_key) document.getElementById('set_api_key').value = settings.api_key;
            if (settings.admin_user) document.getElementById('set_admin_user').value = settings.admin_user;
            if (settings.admin_pass) document.getElementById('set_admin_pass').value = settings.admin_pass;
            
            if (settings.site_favicon) {
                document.getElementById('set_site_favicon').value = settings.site_favicon;
                document.getElementById('dynamic-favicon').href = settings.site_favicon; // åŠ¨æ€æ›´æ–°å½“å‰é¡µé¢å›¾æ ‡
            }
        } catch (err) {
            console.error("åŠ è½½é…ç½®å¤±è´¥", err);
        }
    }

    async function saveSettings() {
        const statusEl = document.getElementById('settingsStatus');
        statusEl.innerText = "ä¿å­˜ä¸­...";
        statusEl.style.color = "#555";

        const updates = {
            tg_bot_token: document.getElementById('set_tg_bot_token').value.trim(),
            tg_chat_id: document.getElementById('set_tg_chat_id').value.trim(),
            api_key: document.getElementById('set_api_key').value.trim(),
            admin_user: document.getElementById('set_admin_user').value.trim(),
            admin_pass: document.getElementById('set_admin_pass').value.trim(),
            site_favicon: document.getElementById('set_site_favicon').value.trim()
        };

        try {
            const res = await fetch(`${apiBaseUrl}/api/admin/settings`, {
                method: 'POST',
                headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            
            if (!res.ok) throw new Error("ä¿å­˜å¤±è´¥");
            
            statusEl.innerText = "âœ… è®¾ç½®ä¿å­˜æˆåŠŸï¼(ä¿®æ”¹è´¦å·å¯†ç åéœ€è¦é‡æ–°ç™»å½•)";
            statusEl.style.color = "#28a745";
            
            // å®æ—¶æ›´æ–°å›¾æ ‡
            if (updates.site_favicon) document.getElementById('dynamic-favicon').href = updates.site_favicon;

            // å¦‚æœä¿®æ”¹äº†è´¦å·æˆ–å¯†ç ï¼Œéœ€è¦æ›´æ–°æœ¬åœ° Auth å¤´ä»¥é˜²åç»­æ¥å£æ— æƒè®¿é—®
            authHeader = 'Basic ' + btoa(updates.admin_user + ':' + updates.admin_pass);
            localStorage.setItem('imgbed_auth', authHeader);

            setTimeout(() => statusEl.innerText = "", 5000);
        } catch (err) {
            statusEl.innerText = "âŒ ä¿å­˜å¤±è´¥: " + err.message;
            statusEl.style.color = "#dc3545";
        }
    }
    setTimeout(() => {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');

        if(dropZone) {
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    uploadImage();
                }
            });
        }
    }, 500);
</script>
</body>
</html>
